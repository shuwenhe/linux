#!/bin/bash
set -e

# ========== ç”¨æˆ·é…ç½®éƒ¨åˆ† ==========
IF_NAME="wlo1"
STATIC_IP="192.168.0.124/24"
GATEWAY="192.168.0.1"
DNS="8.8.8.8, 8.8.4.4"
# ==================================

# è‡ªåŠ¨å¯»æ‰¾ Netplan é…ç½®æ–‡ä»¶
CONFIG_FILE=$(find /etc/netplan -type f -name "*.yaml" | head -n 1)

if [ -z "$CONFIG_FILE" ]; then
  echo "âŒ æœªæ‰¾åˆ° Netplan é…ç½®æ–‡ä»¶"
  exit 1
fi

echo "ðŸ“ ä½¿ç”¨ Netplan æ–‡ä»¶: $CONFIG_FILE"

# å¤‡ä»½åŽŸå§‹æ–‡ä»¶
BACKUP_FILE="${CONFIG_FILE}.bak"
sudo cp "$CONFIG_FILE" "$BACKUP_FILE"
echo "âœ… å·²å¤‡ä»½: $BACKUP_FILE"

# æ¸…ç†å·²æœ‰ default route å®šä¹‰ï¼ˆé¿å…å†²çªï¼‰
sudo sed -i '/routes:/,/[^ ]/d' "$CONFIG_FILE"
sudo sed -i '/gateway4:/d' "$CONFIG_FILE"

# ç”Ÿæˆæ–°é…ç½®
sudo tee "$CONFIG_FILE" > /dev/null <<EOF
network:
  version: 2
  renderer: NetworkManager
  ethernets:
    ${IF_NAME}:
      addresses:
        - ${STATIC_IP}
      nameservers:
        addresses: [${DNS}]
      routes:
        - to: default
          via: ${GATEWAY}
EOF

# åº”ç”¨é…ç½®
echo "âš™ï¸ åº”ç”¨ Netplan é…ç½®..."
sudo netplan apply
echo "âœ… IP é…ç½®å·²ç”Ÿæ•ˆ"

