#!/bin/bash
set -e

# ========== 用户配置部分 ==========
IF_NAME="wlo1"
STATIC_IP="192.168.0.124/24"
GATEWAY="192.168.0.1"
DNS="8.8.8.8, 8.8.4.4"
# ==================================

# 自动寻找 Netplan 配置文件
CONFIG_FILE=$(find /etc/netplan -type f -name "*.yaml" | head -n 1)

if [ -z "$CONFIG_FILE" ]; then
  echo "❌ 未找到 Netplan 配置文件"
  exit 1
fi

echo "📝 使用 Netplan 文件: $CONFIG_FILE"

# 备份原始文件
BACKUP_FILE="${CONFIG_FILE}.bak"
sudo cp "$CONFIG_FILE" "$BACKUP_FILE"
echo "✅ 已备份: $BACKUP_FILE"

# 清理已有 default route 定义（避免冲突）
sudo sed -i '/routes:/,/[^ ]/d' "$CONFIG_FILE"
sudo sed -i '/gateway4:/d' "$CONFIG_FILE"

# 生成新配置
sudo tee "$CONFIG_FILE" > /dev/null <<EOF
network:
  version: 2
  renderer: NetworkManager
  ethernets:
    ${IF_NAME}:
      addresses:
        - ${STATIC_IP}
      nameservers:
        addresses: [${DNS}]
      routes:
        - to: default
          via: ${GATEWAY}
EOF

# 应用配置
echo "⚙️ 应用 Netplan 配置..."
sudo netplan apply
echo "✅ IP 配置已生效"

